generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shop {
  id        Int      @id @default(autoincrement())
  name      String
  location  String?
  phone     String?
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users     User[]
  admins    Admin[]
  tires     Tire[]
  usedTires UsedTire[]
  sales     Sale[]

  @@map("shops")
}

model User {
  id         Int      @id @default(autoincrement())
  telegramId BigInt   @unique @map("telegram_id")
  firstName  String?  @map("first_name")
  lastName   String?  @map("last_name")
  username   String?
  role       Role     @default(USER)
  shopId     Int?     @map("shop_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  shop Shop? @relation(fields: [shopId], references: [id])

  @@index([telegramId])
  @@map("users")
}

model Admin {
  id         Int      @id @default(autoincrement())
  telegramId BigInt   @unique @map("telegram_id")
  shopId     Int      @map("shop_id")
  createdAt  DateTime @default(now()) @map("created_at")

  shop  Shop   @relation(fields: [shopId], references: [id])
  sales Sale[]

  @@index([telegramId])
  @@map("admins")
}

model Tire {
  id        Int      @id @default(autoincrement())
  shopId    Int      @map("shop_id")
  brand     String
  size      String
  priceBuy  Float    @map("price_buy")
  priceSell Float    @map("price_sell")
  quantity  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop          Shop           @relation(fields: [shopId], references: [id])
  sales         Sale[]
  warehouseLogs WarehouseLog[]

  @@unique([shopId, brand, size])
  @@index([shopId])
  @@index([brand])
  @@index([size])
  @@map("tires")
}

model UsedTire {
  id        Int           @id @default(autoincrement())
  shopId    Int           @map("shop_id")
  size      String
  condition TireCondition @default(GOOD)
  priceBuy  Float         @map("price_buy")
  priceSell Float?        @map("price_sell")
  quantity  Int           @default(0)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  shop          Shop           @relation(fields: [shopId], references: [id])
  sales         Sale[]
  warehouseLogs WarehouseLog[]

  @@unique([shopId, size, condition])
  @@index([shopId])
  @@index([size])
  @@map("used_tires")
}

model Sale {
  id         Int      @id @default(autoincrement())
  itemType   ItemType @map("item_type")
  tireId     Int?     @map("tire_id")
  usedTireId Int?     @map("used_tire_id")
  quantity   Int
  totalPrice Float    @map("total_price")
  adminId    Int      @map("admin_id")
  shopId     Int      @map("shop_id")
  createdAt  DateTime @default(now()) @map("created_at")

  tire     Tire?     @relation(fields: [tireId], references: [id])
  usedTire UsedTire? @relation(fields: [usedTireId], references: [id])
  admin    Admin     @relation(fields: [adminId], references: [id])
  shop     Shop      @relation(fields: [shopId], references: [id])

  @@index([itemType])
  @@index([createdAt])
  @@index([shopId])
  @@map("sales")
}

model WarehouseLog {
  id         Int          @id @default(autoincrement())
  itemType   ItemType     @map("item_type")
  tireId     Int?         @map("tire_id")
  usedTireId Int?         @map("used_tire_id")
  logType    LogType      @map("log_type")
  quantity   Int
  price      Float
  createdAt  DateTime     @default(now()) @map("created_at")

  tire     Tire?     @relation(fields: [tireId], references: [id])
  usedTire UsedTire? @relation(fields: [usedTireId], references: [id])

  @@index([itemType])
  @@index([logType])
  @@index([createdAt])
  @@map("warehouse_logs")
}

enum Role {
  USER
  ADMIN
}

enum ItemType {
  NEW
  USED
}

enum LogType {
  IN
  OUT
}

enum TireCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}
